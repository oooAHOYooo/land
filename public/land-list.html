<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AGSCOUT — Land List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      html { scroll-behavior: smooth; }
      .compact-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 0.75rem; }
      .property-card { @apply bg-white border rounded-lg p-3 hover:shadow-md transition-shadow; }
      .pokedex-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.5rem; }
      .pokedex-card { @apply bg-white border rounded p-2 cursor-pointer hover:shadow-sm transition-shadow text-center; }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-900 min-h-screen">
    <!-- Compact Top Navigation -->
    <nav class="bg-white shadow-sm border-b sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-3">
        <div class="flex items-center justify-between h-12">
          <div class="flex items-center space-x-4">
            <h1 class="text-lg font-semibold text-slate-800">AGSCOUT — Land
              List</h1>
            <span class="text-xs text-slate-500">30 properties</span>
          </div>
          <div class="hidden md:flex items-center space-x-4 text-xs">
            <a href="#pokedex"
              class="text-slate-600 hover:text-slate-900">Pokedex</a>
            <a href="#detailed-view"
              class="text-slate-600 hover:text-slate-900">Properties</a>
            <a href="#calculator"
              class="text-slate-600 hover:text-slate-900">Calculator</a>
            <a href="#distance-map"
              class="text-slate-600 hover:text-slate-900">Distance</a>
            <a href="#financing"
              class="text-slate-600 hover:text-slate-900">Financing</a>
            <a href="#strategy"
              class="text-slate-600 hover:text-slate-900">Strategy</a>
            <a href="#vision"
              class="text-slate-600 hover:text-slate-900">Vision</a>
          </div>
          <div class="flex items-center gap-2">
            <button onclick="window.print()"
              class="px-2 py-1 rounded bg-slate-100 text-slate-700 hover:bg-slate-200 text-xs">Print</button>
            <a href="index.html"
              class="px-2 py-1 rounded bg-blue-600 text-white hover:bg-blue-700 text-xs">Hub</a>
          </div>
        </div>
      </div>
    </nav>

    <div class="max-w-7xl mx-auto p-3 space-y-3">
      <!-- Compact Western MA Alternatives -->
      <section
        class="bg-gradient-to-r from-emerald-50 to-teal-50 rounded-lg border p-3">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-sm font-semibold text-slate-800">Western MA
            Alternatives</h2>
          <div class="flex gap-1 text-xs">
            <span
              class="px-2 py-1 bg-emerald-100 text-emerald-800 rounded">Berkshires</span>
            <span
              class="px-2 py-1 bg-blue-100 text-blue-800 rounded">Hilltowns</span>
            <span
              class="px-2 py-1 bg-purple-100 text-purple-800 rounded">Pioneer
              Valley</span>
          </div>
        </div>
        <div
          class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2 text-xs">
          <div class="bg-white p-2 rounded border">
            <div class="font-medium text-emerald-700">Otis</div>
            <div class="text-slate-600">lakes/ponds</div>
          </div>
          <div class="bg-white p-2 rounded border">
            <div class="font-medium text-emerald-700">Monterey</div>
            <div class="text-slate-600">creative, pricier</div>
          </div>
          <div class="bg-white p-2 rounded border">
            <div class="font-medium text-emerald-700">Tyringham</div>
            <div class="text-slate-600">pastoral + wooded</div>
          </div>
          <div class="bg-white p-2 rounded border">
            <div class="font-medium text-blue-700">Hinsdale</div>
            <div class="text-slate-600">rolling woods</div>
          </div>
          <div class="bg-white p-2 rounded border">
            <div class="font-medium text-blue-700">Savoy</div>
            <div class="text-slate-600">brooks, great prices</div>
          </div>
          <div class="bg-white p-2 rounded border">
            <div class="font-medium text-purple-700">Cummington</div>
            <div class="text-slate-600">maker/artist</div>
          </div>
        </div>
      </section>

      <!-- Property Pokedex Grid -->
      <section id="pokedex" class="bg-white rounded-lg border p-3">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-sm font-semibold">Property Pokedex</h2>
          <div class="text-xs text-slate-600">Total: <strong
              id="count">0</strong></div>
        </div>
        <div id="pokedex" class="pokedex-grid"></div>
        <div id="pokedex-empty"
          class="text-center text-slate-500 text-xs hidden">No properties</div>
      </section>

      <!-- Detailed Properties Grid -->
      <section id="detailed-view" class="bg-white rounded-lg border p-3">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-sm font-semibold">Detailed Properties</h2>
          <div class="text-xs text-slate-600">Click property above to view
            details • Right-click to add to calculator</div>
        </div>
        <div id="list" class="compact-grid"></div>
        <div id="empty" class="text-center text-slate-500 text-xs hidden">No
          properties</div>
      </section>

      <!-- Property Calculator Tool -->
      <section id="calculator"
        class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border p-3">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-sm font-semibold text-slate-800">Property
            Calculator</h2>
          <div class="text-xs text-slate-600">Compare & Calculate Costs</div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <h3 class="text-xs font-medium text-slate-700 mb-1">Selected
              Properties</h3>
            <div id="selected-properties"
              class="space-y-1 max-h-32 overflow-y-auto text-xs">
              <div class="text-slate-500 italic">Click properties above to add
                them</div>
            </div>
            <button onclick="clearSelection()"
              class="mt-1 text-xs text-red-600 hover:text-red-700">Clear
              All</button>
          </div>
          <div>
            <h3
              class="text-xs font-medium text-slate-700 mb-1">Calculations</h3>
            <div id="calculator-results" class="space-y-1 text-xs">
              <div class="text-slate-500 italic">Select properties to see
                calculations</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Distance Map -->
      <section id="distance-map"
        class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border p-3">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-sm font-semibold text-slate-800">Distance Map</h2>
          <div class="text-xs text-slate-600">From 206 Saint John Street</div>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2"
          id="distance-map">
          <div class="text-center text-slate-500 italic text-xs">Loading
            distances...</div>
        </div>
      </section>

      <!-- Compact Financing Guide -->
      <section id="financing"
        class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-lg border p-3">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-sm font-semibold text-slate-800">Financing Guide</h2>
          <div class="text-xs text-slate-600">$15K Down Payment Strategy</div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
          <div class="bg-white rounded p-2 border">
            <h3 class="text-xs font-semibold text-red-800 mb-1">Reality
              Check</h3>
            <div class="text-xs text-slate-600">Raw land loans: 20-50% down,
              10-15yr terms, higher rates</div>
          </div>
          <div class="bg-white rounded p-2 border">
            <h3 class="text-xs font-semibold text-blue-800 mb-1">Best Paths</h3>
            <div class="text-xs text-slate-600">1. Credit Union 2. Seller
              Financing 3. Construction-to-Perm</div>
          </div>
          <div class="bg-white rounded p-2 border">
            <h3 class="text-xs font-semibold text-green-800 mb-1">Monthly
              Examples</h3>
            <div class="text-xs text-slate-600">$60k lot: $511-595/mo • $50k
              lot: $463/mo</div>
          </div>
          <div class="bg-white rounded p-2 border">
            <h3 class="text-xs font-semibold text-orange-800 mb-1">Hidden
              Costs</h3>
            <div class="text-xs text-slate-600">Survey: $1.5-4k • Perc: $800-3k
              • Driveway: $6-20k</div>
          </div>
        </div>
      </section>

      <!-- Compact Investment Strategy -->
      <section id="strategy"
        class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg border p-3">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-sm font-semibold text-slate-800">Investment
            Strategy</h2>
          <div class="text-xs text-slate-600">Patterns & Checklists</div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
          <div class="bg-white rounded border">
            <button onclick="toggleDropdown('primary-residence')"
              class="w-full p-2 text-left flex items-center justify-between hover:bg-slate-50">
              <h3 class="text-xs font-semibold text-slate-800">Primary
                Residence</h3>
              <span id="primary-residence-arrow" class="text-slate-400">▼</span>
            </button>
            <div id="primary-residence"
              class="px-2 pb-2 space-y-1 hidden text-xs">
              <div class="flex items-start"><input type="checkbox"
                  class="mt-0.5 mr-1" id="pr-1"><label for="pr-1">Highway
                  access</label></div>
              <div class="flex items-start"><input type="checkbox"
                  class="mt-0.5 mr-1" id="pr-2"><label for="pr-2">Within 30
                  min</label></div>
              <div class="flex items-start"><input type="checkbox"
                  class="mt-0.5 mr-1" id="pr-3"><label for="pr-3">Good
                  schools</label></div>
              <div class="flex items-start"><input type="checkbox"
                  class="mt-0.5 mr-1" id="pr-4"><label for="pr-4">Utilities
                  available</label></div>
            </div>
          </div>
          <div class="bg-white rounded border">
            <button onclick="toggleDropdown('retreat-house')"
              class="w-full p-2 text-left flex items-center justify-between hover:bg-slate-50">
              <h3 class="text-xs font-semibold text-slate-800">Retreat
                House</h3>
              <span id="retreat-house-arrow" class="text-slate-400">▼</span>
            </button>
            <div id="retreat-house" class="px-2 pb-2 space-y-1 hidden text-xs">
              <div class="flex items-start"><input type="checkbox"
                  class="mt-0.5 mr-1" id="rh-1"><label for="rh-1">Water
                  nearby</label></div>
              <div class="flex items-start"><input type="checkbox"
                  class="mt-0.5 mr-1" id="rh-2"><label
                  for="rh-2">Privacy</label></div>
              <div class="flex items-start"><input type="checkbox"
                  class="mt-0.5 mr-1" id="rh-3"><label for="rh-3">Wooded
                  setting</label></div>
              <div class="flex items-start"><input type="checkbox"
                  class="mt-0.5 mr-1" id="rh-4"><label for="rh-4">Off-grid
                  potential</label></div>
            </div>
          </div>
          <div class="bg-white rounded border">
            <button onclick="toggleDropdown('real-estate')"
              class="w-full p-2 text-left flex items-center justify-between hover:bg-slate-50">
              <h3 class="text-xs font-semibold text-slate-800">Investment
                Play</h3>
              <span id="real-estate-arrow" class="text-slate-400">▼</span>
            </button>
            <div id="real-estate" class="px-2 pb-2 space-y-1 hidden text-xs">
              <div class="flex items-start"><input type="checkbox"
                  class="mt-0.5 mr-1" id="re-1"><label for="re-1">Low
                  price/acre</label></div>
              <div class="flex items-start"><input type="checkbox"
                  class="mt-0.5 mr-1" id="re-2"><label for="re-2">Development
                  potential</label></div>
              <div class="flex items-start"><input type="checkbox"
                  class="mt-0.5 mr-1" id="re-3"><label for="re-3">Growing
                  area</label></div>
              <div class="flex items-start"><input type="checkbox"
                  class="mt-0.5 mr-1" id="re-4"><label for="re-4">Multiple
                  exits</label></div>
            </div>
          </div>
          <div class="bg-white rounded border">
            <button onclick="toggleDropdown('portfolio-analysis')"
              class="w-full p-2 text-left flex items-center justify-between hover:bg-slate-50">
              <h3 class="text-xs font-semibold text-slate-800">Portfolio
                Analysis</h3>
              <span id="portfolio-analysis-arrow"
                class="text-slate-400">▼</span>
            </button>
            <div id="portfolio-analysis"
              class="px-2 pb-2 space-y-1 hidden text-xs">
              <div class="text-slate-500 italic">Loading analysis...</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Compact Vision -->
      <section id="vision"
        class="bg-gradient-to-r from-slate-50 to-gray-50 rounded-lg border p-3">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-sm font-semibold text-slate-800">Off-Grid Film Retreat
            Vision</h2>
          <div class="text-xs text-slate-600">Creative Sanctuary
            Development</div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
          <div class="bg-white rounded p-2 border">
            <h3 class="text-xs font-semibold text-slate-800 mb-1">The
              Vision</h3>
            <div class="text-xs text-slate-600">Hand-built creative sanctuary
              for film work, writing, editing. Modular growth over time.</div>
          </div>
          <div class="bg-white rounded p-2 border">
            <h3
              class="text-xs font-semibold text-slate-800 mb-1">Structures</h3>
            <div class="text-xs text-slate-600">2-3 Yurts • Stone/Timber Studio
              • Treehouses • Solar • Water System</div>
          </div>
          <div class="bg-white rounded p-2 border">
            <h3 class="text-xs font-semibold text-slate-800 mb-1">Land
              Requirements</h3>
            <div class="text-xs text-slate-600">5-15 acres • Water access • Road
              access • Western MA/VT/ME preferred</div>
          </div>
          <div class="bg-white rounded p-2 border">
            <h3 class="text-xs font-semibold text-slate-800 mb-1">Timeline</h3>
            <div class="text-xs text-slate-600">Yr 1: Land + first yurt • Yr 2:
              Water + solar • Yr 3: Studio • Yr 4-5: Treehouses</div>
          </div>
        </div>
      </section>
    </div>

    <script>
      async function main() {
        try {
          const res = await fetch('data/land.json', { cache: 'no-store' });
          if (!res.ok) throw new Error('Failed to load JSON');
          const rows = await res.json();
          const allRows = Array.isArray(rows) ? rows : [];
          // Filter to only show properties with images
          const arr = allRows.filter(property => {
            const images = Array.isArray(property.Images) ? property.Images : [];
            return images.length > 0;
          });
          allProperties = arr;
          document.getElementById('count').textContent = String(arr.length);
          
          const pokedexContainer = document.getElementById('pokedex');
          const pokedexEmpty = document.getElementById('pokedex-empty');
          const container = document.getElementById('list');
          const empty = document.getElementById('empty');
          
          if (arr.length === 0) { 
            pokedexEmpty.classList.remove('hidden');
            empty.classList.remove('hidden'); 
            return; 
          }
          
          const fmtCurrency = (v) => (v==null||!isFinite(Number(v)) ? '' : '$' + Number(v).toLocaleString(undefined, { maximumFractionDigits: 0 }));
          const fmtNumber = (v, d=2) => (v==null||!isFinite(Number(v)) ? '' : Number(v).toLocaleString(undefined, { maximumFractionDigits: d }));
          const escapeHtml = (s) => String(s==null?'':s)
            .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');

          // Generate compact Pokedex cards
          const pokedexCards = arr.map((r, index) => {
            const title = `${r.Town || ''} — ${r.Parcel || ''}`.trim();
            const water = (r.WaterProximity===0) ? 'adjacent' : ((r.WaterProximity!=null && isFinite(Number(r.WaterProximity)) && Number(r.WaterProximity)<=900) ? 'near' : 'far');
            const images = Array.isArray(r.Images) ? r.Images : [];
            const firstImage = images.length > 0 ? images[0] : null;
            
            return `
            <div class="pokedex-card" 
                 onclick="navigateToProperty(${index})"
                 oncontextmenu="event.preventDefault(); togglePropertySelection(${index}); return false;"
                 data-property-index="${index}"
                 id="pokedex-card-${index}"
                 title="Click to view details • Right-click to add to calculator">
              <div class="w-16 h-16 mx-auto mb-1 bg-slate-100 rounded overflow-hidden">
                ${firstImage ? `
                  <img src="${escapeHtml(firstImage)}" 
                       alt="${escapeHtml(title)}" 
                       class="w-full h-full object-cover"
                       loading="lazy"
                       onerror="this.style.display='none'">
                ` : `
                  <div class="w-full h-full flex items-center justify-center text-slate-400 text-xs">
                    No Image
                  </div>
                `}
              </div>
              <div class="font-semibold text-xs truncate" title="${escapeHtml(title)}">${escapeHtml(title)}</div>
              <div class="text-sm font-bold text-green-600">${escapeHtml(fmtCurrency(r.Price))}</div>
              <div class="text-xs text-slate-500">${escapeHtml(fmtNumber(r.Acres))} acres</div>
              <div class="flex justify-center gap-1 mt-1">
                <span class="px-1 py-0.5 bg-slate-100 text-xs rounded">${escapeHtml(String(r.Tag||'inbox'))}</span>
                <span class="px-1 py-0.5 bg-blue-100 text-xs rounded">${escapeHtml(water)}</span>
              </div>
            </div>`;
          }).join('\n');
          
          pokedexContainer.innerHTML = pokedexCards;

          // Generate compact detailed cards
          const cards = arr.map((r, index) => {
            const title = `${r.Town || ''} — ${r.Parcel || ''}`.trim();
            const details = (r.Note || '').split(/\n+/).slice(0, 3).map(p => `<p class="text-xs text-slate-600">${escapeHtml(p)}</p>`).join('');
            const ppa = (r.Price && r.Acres) ? (Number(r.Price)/Number(r.Acres)) : null;
            const water = (r.WaterProximity===0) ? 'adjacent' : ((r.WaterProximity!=null && isFinite(Number(r.WaterProximity)) && Number(r.WaterProximity)<=900) ? 'near' : 'far');
            
            const images = Array.isArray(r.Images) ? r.Images : [];
            const imageHtml = images.length > 0 ? `
              <div class="mb-2">
                <div class="grid grid-cols-3 gap-1">
                  ${images.slice(0, 3).map(img => `
                    <img src="${escapeHtml(img)}" 
                         alt="${escapeHtml(title)}" 
                         class="w-full h-16 object-cover rounded border"
                         loading="lazy"
                         onerror="this.style.display='none'">
                  `).join('')}
                </div>
                ${images.length > 3 ? `<div class="text-xs text-slate-500 mt-1">+${images.length - 3} more</div>` : ''}
              </div>
            ` : '';
            
            return `
            <div id="property-${index}" class="property-card">
              ${imageHtml}
              <div class="flex items-start justify-between gap-2 mb-2">
                <div class="min-w-0 flex-1">
                  <div class="font-semibold text-sm truncate">${escapeHtml(title)}</div>
                  <div class="text-xs text-slate-500 truncate">${escapeHtml([r.State, r.County].filter(Boolean).join(', '))}</div>
                </div>
                <div class="text-right flex-none">
                  <div class="text-sm font-medium">${escapeHtml(fmtCurrency(r.Price))}</div>
                  <div class="text-xs text-slate-500">${escapeHtml(fmtNumber(r.Acres))} acres</div>
                </div>
              </div>
              <div class="grid grid-cols-3 gap-2 text-xs mb-2">
                <div><div class="text-slate-500">$/acre</div><div class="font-medium">${ppa!=null ? escapeHtml(fmtCurrency(ppa)) : ''}</div></div>
                <div><div class="text-slate-500">Water</div><div class="font-medium">${escapeHtml(water)}</div></div>
                <div><div class="text-slate-500">Tag</div><div class="font-medium">${escapeHtml(String(r.Tag||'inbox'))}</div></div>
              </div>
              <div class="flex items-center gap-2 text-xs">
                ${r.Link ? `<a href="${escapeHtml(r.Link)}" target="_blank" class="text-teal-600 underline">View listing</a>` : ''}
              </div>
              ${details ? `<div class="mt-2 space-y-1">${details}</div>` : ''}
            </div>`;
          }).join('\n');
          container.innerHTML = cards;
          
          generateDistanceMap(arr);
        } catch (e) {
          document.getElementById('empty').textContent = 'Failed to load land.json';
          document.getElementById('empty').classList.remove('hidden');
        }
      }

      // Global variables for calculator
      let selectedProperties = [];
      let allProperties = [];

      // Navigate to property
      function navigateToProperty(index) {
        const element = document.getElementById(`property-${index}`);
        if (element) {
          element.scrollIntoView({ behavior: 'smooth', block: 'start' });
          element.style.backgroundColor = '#fef3c7';
          setTimeout(() => { element.style.backgroundColor = ''; }, 2000);
        }
      }

      // Toggle property selection
      function togglePropertySelection(index) {
        const property = allProperties[index];
        if (!property) return;

        const card = document.getElementById(`pokedex-card-${index}`);
        const isSelected = selectedProperties.some(p => p.index === index);
        
        if (isSelected) {
          selectedProperties = selectedProperties.filter(p => p.index !== index);
          card.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50');
        } else {
          selectedProperties.push({...property, index});
          card.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50');
        }
        
        updateCalculator();
      }

      // Update calculator display
      function updateCalculator() {
        const selectedContainer = document.getElementById('selected-properties');
        const resultsContainer = document.getElementById('calculator-results');
        
        if (selectedProperties.length === 0) {
          selectedContainer.innerHTML = '<div class="text-xs text-slate-500 italic">Click properties above to add them</div>';
          resultsContainer.innerHTML = '<div class="text-slate-500 italic text-xs">Select properties to see calculations</div>';
          return;
        }

        selectedContainer.innerHTML = selectedProperties.map((prop, i) => `
          <div class="flex items-center justify-between bg-white p-1 rounded border">
            <div class="flex-1">
              <div class="font-medium text-xs">${prop.Town} — ${prop.Parcel}</div>
              <div class="text-xs text-slate-500">$${Number(prop.Price).toLocaleString()} • ${prop.Acres} acres</div>
            </div>
            <button onclick="removeFromSelection(${i})" class="text-red-500 hover:text-red-700 text-xs">×</button>
          </div>
        `).join('');

        const totalPrice = selectedProperties.reduce((sum, prop) => sum + Number(prop.Price), 0);
        const totalAcres = selectedProperties.reduce((sum, prop) => sum + Number(prop.Acres), 0);
        const avgPricePerAcre = totalAcres > 0 ? totalPrice / totalAcres : 0;
        
        const downPayment = totalPrice * 0.20;
        const loanAmount = totalPrice - downPayment;
        const monthlyRate = 0.065 / 12;
        const numPayments = 30 * 12;
        const monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);
        
        const annualTax = totalPrice * 0.015;
        const monthlyTax = annualTax / 12;
        const annualInsurance = totalPrice * 0.003;
        const monthlyInsurance = annualInsurance / 12;
        const totalMonthly = monthlyPayment + monthlyTax + monthlyInsurance;

        resultsContainer.innerHTML = `
          <div class="space-y-2">
            <div class="grid grid-cols-2 gap-1 text-xs">
              <div class="bg-white p-1 rounded border">
                <div class="text-slate-500">Properties</div>
                <div class="font-semibold">${selectedProperties.length}</div>
              </div>
              <div class="bg-white p-1 rounded border">
                <div class="text-slate-500">Total Price</div>
                <div class="font-semibold">$${totalPrice.toLocaleString()}</div>
              </div>
              <div class="bg-white p-1 rounded border">
                <div class="text-slate-500">Total Acres</div>
                <div class="font-semibold">${totalAcres.toFixed(1)}</div>
              </div>
              <div class="bg-white p-1 rounded border">
                <div class="text-slate-500">Avg $/Acre</div>
                <div class="font-semibold">$${avgPricePerAcre.toLocaleString()}</div>
              </div>
            </div>
            
            <div class="bg-green-50 p-2 rounded border border-green-200">
              <div class="text-xs font-semibold text-green-800 mb-1">Monthly Costs</div>
              <div class="space-y-1 text-xs">
                <div class="flex justify-between">
                  <span>Mortgage (20% down, 6.5%)</span>
                  <span class="font-medium">$${monthlyPayment.toFixed(0)}</span>
                </div>
                <div class="flex justify-between">
                  <span>Tax + Insurance</span>
                  <span class="font-medium">$${(monthlyTax + monthlyInsurance).toFixed(0)}</span>
                </div>
                <div class="flex justify-between border-t pt-1 font-semibold text-green-800">
                  <span>Total Monthly</span>
                  <span>$${totalMonthly.toFixed(0)}</span>
                </div>
              </div>
            </div>
            
            <div class="bg-blue-50 p-2 rounded border border-blue-200">
              <div class="text-xs font-semibold text-blue-800 mb-1">Down Payment</div>
              <div class="text-sm font-bold text-blue-900">$${downPayment.toLocaleString()}</div>
            </div>
          </div>
        `;
      }

      // Remove property from selection
      function removeFromSelection(index) {
        const removed = selectedProperties[index];
        selectedProperties.splice(index, 1);
        const card = document.getElementById(`pokedex-card-${removed.index}`);
        card.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50');
        updateCalculator();
      }

      // Clear all selections
      function clearSelection() {
        selectedProperties.forEach(prop => {
          const card = document.getElementById(`pokedex-card-${prop.index}`);
          card.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50');
        });
        selectedProperties = [];
        updateCalculator();
      }

      // Toggle dropdown sections
      function toggleDropdown(sectionId) {
        const section = document.getElementById(sectionId);
        const arrow = document.getElementById(sectionId + '-arrow');
        
        if (section.classList.contains('hidden')) {
          section.classList.remove('hidden');
          arrow.textContent = '▲';
        } else {
          section.classList.add('hidden');
          arrow.textContent = '▼';
        }
      }

      // Generate distance map
      function generateDistanceMap(properties) {
        const homeAddress = "206 Saint John Street";
        const distanceContainer = document.getElementById('distance-map');
        
        if (properties.length === 0) {
          distanceContainer.innerHTML = '<div class="text-center text-slate-500 italic text-xs">No properties to map</div>';
          return;
        }

        const homeCoords = { lat: 41.3083, lng: -72.9279 };
        
        const distanceCards = properties.map((prop, index) => {
          const address = `${prop.Parcel}, ${prop.Town}, ${prop.State}`;
          const distance = calculateDistance(homeCoords, getPropertyCoords(prop));
          const driveTime = estimateDriveTime(distance);
          
          const images = Array.isArray(prop.Images) ? prop.Images : [];
          const firstImage = images.length > 0 ? images[0] : null;
          
          return `
            <div class="bg-white rounded p-2 border shadow-sm text-center">
              <div class="text-xs font-medium text-slate-700 mb-1">${prop.Town}, ${prop.State}</div>
              <div class="text-xs text-slate-500 mb-2 truncate" title="${address}">${prop.Parcel}</div>
              
              <div class="mb-2 flex justify-center">
                <div class="w-8 h-8 rounded border overflow-hidden bg-slate-100">
                  ${firstImage ? `
                    <img src="${firstImage}" 
                         alt="${prop.Town} property" 
                         class="w-full h-full object-cover"
                         loading="lazy"
                         onerror="this.style.display='none'">
                  ` : `
                    <div class="w-full h-full flex items-center justify-center text-slate-400 text-xs">
                      No Image
                    </div>
                  `}
                </div>
              </div>
              
              <div class="text-lg font-bold text-green-600 mb-1">${distance.toFixed(1)} mi</div>
              <div class="text-xs text-slate-600 mb-1">${driveTime}</div>
              <div class="text-xs text-slate-500">$${Number(prop.Price).toLocaleString()}</div>
              <div class="text-xs text-slate-500">${prop.Acres} acres</div>
            </div>
          `;
        }).join('');

        distanceContainer.innerHTML = distanceCards;
      }

      // Get property coordinates
      function getPropertyCoords(property) {
        const coords = {
          'Cheshire': { lat: 41.4981, lng: -72.9007 },
          'Sherman': { lat: 41.5804, lng: -73.4962 },
          'Torrington': { lat: 41.8009, lng: -73.1212 },
          'Smithfield': { lat: 41.8887, lng: -71.5495 },
          'Lebanon': { lat: 41.6440, lng: -72.2100 },
          'Norwich': { lat: 41.5245, lng: -72.0759 },
          'Putnam': { lat: 41.9154, lng: -71.9089 },
          'Clifton Park': { lat: 42.8656, lng: -73.7708 },
          'Monterey': { lat: 42.1895, lng: -73.2121 },
          'Tolland': { lat: 42.0648, lng: -72.9990 },
          'Ware': { lat: 42.2598, lng: -72.2398 },
          'New Marlborough': { lat: 42.1220, lng: -73.2284 },
          'Brimfield': { lat: 42.1226, lng: -72.2006 },
          'Sheffield': { lat: 42.1098, lng: -73.3551 },
          'Becket': { lat: 42.3333, lng: -73.0833 },
          'Hinsdale': { lat: 42.4333, lng: -73.1167 },
          'Florida': { lat: 42.6667, lng: -73.0167 },
          'North Adams': { lat: 42.7000, lng: -73.1167 }
        };
        
        return coords[property.Town] || { lat: 41.3083, lng: -72.9279 };
      }

      // Calculate distance using Haversine formula
      function calculateDistance(coord1, coord2) {
        const R = 3959;
        const dLat = (coord2.lat - coord1.lat) * Math.PI / 180;
        const dLng = (coord2.lng - coord1.lng) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(coord1.lat * Math.PI / 180) * Math.cos(coord2.lat * Math.PI / 180) *
                  Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      }

      // Estimate drive time
      function estimateDriveTime(distance) {
        if (distance < 5) return '~10-15 min';
        if (distance < 15) return '~20-30 min';
        if (distance < 30) return '~30-45 min';
        if (distance < 50) return '~45-60 min';
        return '~1+ hours';
      }

      main();
    </script>
    <style>
      @media print { .no-print { display: none !important; } body { background: white; } }
    </style>
  </body>
</html>