<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AGSCOUT ‚Äî Land List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="js/acreAnalysis.js"></script>
    <style>
      html { scroll-behavior: smooth; }
      .compact-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1rem; }
      .property-card { @apply bg-white border rounded-lg p-4 shadow-sm hover:shadow-md transition-all; }
      .grid-menu { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem; }
      .menu-item { 
        @apply bg-white border rounded-lg p-3 cursor-pointer hover:shadow-md transition-all duration-200 text-center shadow-sm;
        border-left: 4px solid #e5e7eb;
      }
      .menu-item:hover {
        border-left-color: #3b82f6;
        transform: translateY(-1px);
      }
      .menu-item.selected {
        border-left-color: #10b981;
        background-color: #f0fdf4;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
      }
      .nav-link {
        @apply px-3 py-2 rounded-lg text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-slate-100 transition-colors;
      }
      .mobile-nav-link {
        @apply block px-3 py-2 rounded-lg text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-slate-100 transition-colors;
      }
      .action-btn {
        @apply px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors;
      }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-900 min-h-screen">
    <!-- Enhanced Top Navigation -->
    <nav class="bg-white shadow-sm border-b sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-3">
        <div class="flex items-center justify-between h-14">
          <div class="flex items-center space-x-4">
            <h1 class="text-xl font-bold text-slate-800">AGSCOUT ‚Äî Land
              List</h1>
            <span
              class="text-sm text-slate-500 bg-slate-100 px-2 py-1 rounded-full"
              id="property-count">Loading...</span>
          </div>

          <!-- Main Navigation -->
          <div class="hidden lg:flex items-center space-x-1">
            <a href="#grid-menu" class="nav-link">Overview</a>
            <a href="#detailed-view" class="nav-link">Properties</a>
            <a href="#calculator" class="nav-link">Calculator</a>
            <a href="#distance-map" class="nav-link">Distance</a>
            <a href="#financing" class="nav-link">Financing</a>
            <a href="#strategy" class="nav-link">Strategy</a>
            <a href="#vision" class="nav-link">Vision</a>
          </div>

          <!-- Mobile Menu Button -->
          <div class="lg:hidden">
            <button onclick="toggleMobileMenu()"
              class="p-2 rounded-lg hover:bg-slate-100">
              <svg class="w-5 h-5" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round"
                  stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
              </svg>
            </button>
          </div>

          <!-- Action Buttons -->
          <div class="flex items-center gap-2">
            <button onclick="window.print()"
              class="action-btn bg-slate-100 text-slate-700 hover:bg-slate-200">
              <svg class="w-4 h-4" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round"
                  stroke-width="2"
                  d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
              </svg>
              <span class="hidden sm:inline">Print</span>
            </button>
            <a href="index.html"
              class="action-btn bg-blue-600 text-white hover:bg-blue-700">
              <svg class="w-4 h-4" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
              </svg>
              <span class="hidden sm:inline">Hub</span>
            </a>
            <button onclick="toggleResearchMode()" class="action-btn bg-emerald-600 text-white hover:bg-emerald-700" title="Toggle Research Mode">Research Mode</button>
          </div>
        </div>

        <!-- Mobile Navigation Menu -->
        <div id="mobile-menu" class="lg:hidden hidden border-t bg-slate-50">
          <div class="px-3 py-2 space-y-1">
            <a href="#grid-menu" class="mobile-nav-link"
              onclick="closeMobileMenu()">Overview</a>
            <a href="#detailed-view" class="mobile-nav-link"
              onclick="closeMobileMenu()">Properties</a>
            <a href="#calculator" class="mobile-nav-link"
              onclick="closeMobileMenu()">Calculator</a>
            <a href="#distance-map" class="mobile-nav-link"
              onclick="closeMobileMenu()">Distance</a>
            <a href="#financing" class="mobile-nav-link"
              onclick="closeMobileMenu()">Financing</a>
            <a href="#strategy" class="mobile-nav-link"
              onclick="closeMobileMenu()">Strategy</a>
            <a href="#vision" class="mobile-nav-link"
              onclick="closeMobileMenu()">Vision</a>
          </div>
        </div>
      </div>
    </nav>

    <div class="max-w-7xl mx-auto p-3 space-y-3">
      <!-- Compact Western MA Alternatives -->
      <section
        class="bg-gradient-to-r from-emerald-50 to-teal-50 rounded-lg border p-3">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-sm font-semibold text-slate-800">Western MA
            Alternatives</h2>
          <div class="flex gap-1 text-xs">
            <span
              class="px-2 py-1 bg-emerald-100 text-emerald-800 rounded">Berkshires</span>
            <span
              class="px-2 py-1 bg-blue-100 text-blue-800 rounded">Hilltowns</span>
            <span
              class="px-2 py-1 bg-purple-100 text-purple-800 rounded">Pioneer
              Valley</span>
          </div>
        </div>
        <div
          class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2 text-xs">
          <div class="bg-white p-2 rounded border">
            <div class="font-medium text-emerald-700">Otis</div>
            <div class="text-slate-600">lakes/ponds</div>
          </div>
          <div class="bg-white p-2 rounded border">
            <div class="font-medium text-emerald-700">Monterey</div>
            <div class="text-slate-600">creative, pricier</div>
          </div>
          <div class="bg-white p-2 rounded border">
            <div class="font-medium text-emerald-700">Tyringham</div>
            <div class="text-slate-600">pastoral + wooded</div>
          </div>
          <div class="bg-white p-2 rounded border">
            <div class="font-medium text-blue-700">Hinsdale</div>
            <div class="text-slate-600">rolling woods</div>
          </div>
          <div class="bg-white p-2 rounded border">
            <div class="font-medium text-blue-700">Savoy</div>
            <div class="text-slate-600">brooks, great prices</div>
          </div>
          <div class="bg-white p-2 rounded border">
            <div class="font-medium text-purple-700">Cummington</div>
            <div class="text-slate-600">maker/artist</div>
          </div>
        </div>
      </section>

      <!-- Market Benchmarks -->
      <section id="market-benchmarks" class="bg-white rounded-lg border p-3">
        <button onclick="toggleDropdown('benchmarks-body')" class="w-full text-left flex items-center justify-between">
          <h2 class="text-base font-semibold">Market Benchmarks</h2>
          <span id="benchmarks-body-arrow" class="text-slate-400">‚ñº</span>
        </button>
        <div id="benchmarks-body" class="mt-2 hidden">
          <div id="benchmarks-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2"></div>
          <div id="benchmarks-empty" class="text-xs text-slate-500 italic">Loading benchmarks...</div>
          <div class="mt-3 border-t pt-3">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-sm font-semibold text-slate-800">Region Acre Stats (computed)</h3>
              <a href="data/region_acre_stats.json" target="_blank" class="text-xs text-emerald-700 underline">View JSON</a>
            </div>
            <div id="region-stats-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2"></div>
            <div id="region-stats-empty" class="text-xs text-slate-500 italic">Loading region acre stats...</div>
          </div>
        </div>
      </section>

      <!-- Property Grid Menu -->
      <section id="grid-menu" class="bg-white rounded-lg border p-3">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-sm font-semibold">Property Grid Menu</h2>
          <div class="text-xs text-slate-600">Total: <strong
              id="count">0</strong> properties</div>
        </div>
        <div id="grid-menu" class="grid-menu"></div>
        <div id="grid-menu-empty"
          class="text-center text-slate-500 text-sm hidden py-8">
          <div class="text-4xl mb-2">üèûÔ∏è</div>
          <div>No properties found</div>
        </div>
      </section>

      <!-- Detailed Properties Grid -->
      <section id="detailed-view" class="bg-white rounded-lg border p-3">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-sm font-semibold">Properties</h2>
          <div class="text-xs text-slate-600">Right-click properties to add to
            calculator</div>
        </div>
        <div id="list" class="compact-grid"></div>
        <div id="empty" class="text-center text-slate-500 text-xs hidden">No
          properties</div>
      </section>

      <!-- Property Calculator Tool -->
      <section id="calculator"
        class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border p-3">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-sm font-semibold text-slate-800">Property
            Calculator</h2>
          <div class="text-xs text-slate-600">Compare & Calculate Costs</div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <h3 class="text-xs font-medium text-slate-700 mb-1">Selected
              Properties</h3>
            <div id="selected-properties"
              class="space-y-1 max-h-32 overflow-y-auto text-xs">
              <div class="text-slate-500 italic">Click properties above to add
                them</div>
            </div>
            <button onclick="clearSelection()"
              class="mt-1 text-xs text-red-600 hover:text-red-700">Clear
              All</button>
          </div>
          <div>
            <h3
              class="text-xs font-medium text-slate-700 mb-1">Calculations</h3>
            <div id="calculator-results" class="space-y-1 text-xs">
              <div class="text-slate-500 italic">Select properties to see
                calculations</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Distance Map -->
      <section id="distance-map"
        class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border p-3">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-sm font-semibold text-slate-800">Distance Map</h2>
          <div class="text-xs text-slate-600">From 206 Saint John Street</div>
        </div>
        <div
          class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-3"
          id="distance-map">
          <div
            class="text-center text-slate-500 italic text-xs col-span-full">Loading
            distances...</div>
        </div>
      </section>

      <!-- Compact Financing Guide -->
      <section id="financing"
        class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-lg border p-3">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-sm font-semibold text-slate-800">Financing Guide</h2>
          <div class="text-xs text-slate-600">$15K Down Payment Strategy</div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
          <div class="bg-white rounded p-2 border">
            <h3 class="text-xs font-semibold text-red-800 mb-1">Reality
              Check</h3>
            <div class="text-xs text-slate-600">Raw land loans: 20-50% down,
              10-15yr terms, higher rates</div>
          </div>
          <div class="bg-white rounded p-2 border">
            <h3 class="text-xs font-semibold text-blue-800 mb-1">Best Paths</h3>
            <div class="text-xs text-slate-600">1. Credit Union 2. Seller
              Financing 3. Construction-to-Perm</div>
          </div>
          <div class="bg-white rounded p-2 border">
            <h3 class="text-xs font-semibold text-green-800 mb-1">Monthly
              Examples</h3>
            <div class="text-xs text-slate-600">$60k lot: $511-595/mo ‚Ä¢ $50k
              lot: $463/mo</div>
          </div>
          <div class="bg-white rounded p-2 border">
            <h3 class="text-xs font-semibold text-orange-800 mb-1">Hidden
              Costs</h3>
            <div class="text-xs text-slate-600">Survey: $1.5-4k ‚Ä¢ Perc: $800-3k
              ‚Ä¢ Driveway: $6-20k</div>
          </div>
        </div>
      </section>

      <!-- Compact Investment Strategy -->
      <section id="strategy"
        class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg border p-3">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-sm font-semibold text-slate-800">Investment
            Strategy</h2>
          <div class="text-xs text-slate-600">Patterns & Checklists</div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
          <div class="bg-white rounded border">
            <button onclick="toggleDropdown('primary-residence')"
              class="w-full p-2 text-left flex items-center justify-between hover:bg-slate-50">
              <h3 class="text-xs font-semibold text-slate-800">Primary
                Residence</h3>
              <span id="primary-residence-arrow" class="text-slate-400">‚ñº</span>
            </button>
            <div id="primary-residence"
              class="px-2 pb-2 space-y-1 hidden text-xs">
              <div class="flex items-start"><input type="checkbox"
                  class="mt-0.5 mr-1" id="pr-1"><label for="pr-1">Highway
                  access</label></div>
              <div class="flex items-start"><input type="checkbox"
                  class="mt-0.5 mr-1" id="pr-2"><label for="pr-2">Within 30
                  min</label></div>
              <div class="flex items-start"><input type="checkbox"
                  class="mt-0.5 mr-1" id="pr-3"><label for="pr-3">Good
                  schools</label></div>
              <div class="flex items-start"><input type="checkbox"
                  class="mt-0.5 mr-1" id="pr-4"><label for="pr-4">Utilities
                  available</label></div>
            </div>
          </div>
          <div class="bg-white rounded border">
            <button onclick="toggleDropdown('retreat-house')"
              class="w-full p-2 text-left flex items-center justify-between hover:bg-slate-50">
              <h3 class="text-xs font-semibold text-slate-800">Retreat
                House</h3>
              <span id="retreat-house-arrow" class="text-slate-400">‚ñº</span>
            </button>
            <div id="retreat-house" class="px-2 pb-2 space-y-1 hidden text-xs">
              <div class="flex items-start"><input type="checkbox"
                  class="mt-0.5 mr-1" id="rh-1"><label for="rh-1">Water
                  nearby</label></div>
              <div class="flex items-start"><input type="checkbox"
                  class="mt-0.5 mr-1" id="rh-2"><label
                  for="rh-2">Privacy</label></div>
              <div class="flex items-start"><input type="checkbox"
                  class="mt-0.5 mr-1" id="rh-3"><label for="rh-3">Wooded
                  setting</label></div>
              <div class="flex items-start"><input type="checkbox"
                  class="mt-0.5 mr-1" id="rh-4"><label for="rh-4">Off-grid
                  potential</label></div>
            </div>
          </div>
          <div class="bg-white rounded border">
            <button onclick="toggleDropdown('real-estate')"
              class="w-full p-2 text-left flex items-center justify-between hover:bg-slate-50">
              <h3 class="text-xs font-semibold text-slate-800">Investment
                Play</h3>
              <span id="real-estate-arrow" class="text-slate-400">‚ñº</span>
            </button>
            <div id="real-estate" class="px-2 pb-2 space-y-1 hidden text-xs">
              <div class="flex items-start"><input type="checkbox"
                  class="mt-0.5 mr-1" id="re-1"><label for="re-1">Low
                  price/acre</label></div>
              <div class="flex items-start"><input type="checkbox"
                  class="mt-0.5 mr-1" id="re-2"><label for="re-2">Development
                  potential</label></div>
              <div class="flex items-start"><input type="checkbox"
                  class="mt-0.5 mr-1" id="re-3"><label for="re-3">Growing
                  area</label></div>
              <div class="flex items-start"><input type="checkbox"
                  class="mt-0.5 mr-1" id="re-4"><label for="re-4">Multiple
                  exits</label></div>
            </div>
          </div>
          <div class="bg-white rounded border">
            <button onclick="toggleDropdown('portfolio-analysis')"
              class="w-full p-2 text-left flex items-center justify-between hover:bg-slate-50">
              <h3 class="text-xs font-semibold text-slate-800">Portfolio
                Analysis</h3>
              <span id="portfolio-analysis-arrow"
                class="text-slate-400">‚ñº</span>
            </button>
            <div id="portfolio-analysis"
              class="px-2 pb-2 space-y-1 hidden text-xs">
              <div class="text-slate-500 italic">Loading analysis...</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Compact Vision -->
      <section id="vision"
        class="bg-gradient-to-r from-slate-50 to-gray-50 rounded-lg border p-3">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-sm font-semibold text-slate-800">Off-Grid Film Retreat
            Vision</h2>
          <div class="text-xs text-slate-600">Creative Sanctuary
            Development</div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
          <div class="bg-white rounded p-2 border">
            <h3 class="text-xs font-semibold text-slate-800 mb-1">The
              Vision</h3>
            <div class="text-xs text-slate-600">Hand-built creative sanctuary
              for film work, writing, editing. Modular growth over time.</div>
          </div>
          <div class="bg-white rounded p-2 border">
            <h3
              class="text-xs font-semibold text-slate-800 mb-1">Structures</h3>
            <div class="text-xs text-slate-600">2-3 Yurts ‚Ä¢ Stone/Timber Studio
              ‚Ä¢ Treehouses ‚Ä¢ Solar ‚Ä¢ Water System</div>
          </div>
          <div class="bg-white rounded p-2 border">
            <h3 class="text-xs font-semibold text-slate-800 mb-1">Land
              Requirements</h3>
            <div class="text-xs text-slate-600">5-15 acres ‚Ä¢ Water access ‚Ä¢ Road
              access ‚Ä¢ Western MA/VT/ME preferred</div>
          </div>
          <div class="bg-white rounded p-2 border">
            <h3 class="text-xs font-semibold text-slate-800 mb-1">Timeline</h3>
            <div class="text-xs text-slate-600">Yr 1: Land + first yurt ‚Ä¢ Yr 2:
              Water + solar ‚Ä¢ Yr 3: Studio ‚Ä¢ Yr 4-5: Treehouses</div>
          </div>
        </div>
      </section>
    </div>

    <script>
      async function main() {
        try {
          // Load benchmarks
          loadBenchmarks();
          // Load region stats for acre analysis and UI list
          regionStats = await window.acreAnalysis.loadRegionStats();
          renderRegionStats(regionStats);

          const res = await fetch('data/land.json', { cache: 'no-store' });
          if (!res.ok) throw new Error('Failed to load JSON');
          const rows = await res.json();
          const allRows = Array.isArray(rows) ? rows : [];
          // Filter to only show properties with images
          const arr = allRows.filter(property => {
            const images = Array.isArray(property.Images) ? property.Images : [];
            return images.length > 0;
          });
          allProperties = arr;
          document.getElementById('count').textContent = String(arr.length).padStart(3, '0');
          document.getElementById('property-count').textContent = `${arr.length} properties`;
          
          const gridMenuContainer = document.getElementById('grid-menu');
          const gridMenuEmpty = document.getElementById('grid-menu-empty');
          const container = document.getElementById('list');
          const empty = document.getElementById('empty');
          
          if (arr.length === 0) { 
            gridMenuEmpty.classList.remove('hidden');
            empty.classList.remove('hidden'); 
            return; 
          }
          
          const fmtCurrency = (v) => (v==null||!isFinite(Number(v)) ? '' : '$' + Number(v).toLocaleString(undefined, { maximumFractionDigits: 0 }));
          const fmtNumber = (v, d=2) => (v==null||!isFinite(Number(v)) ? '' : Number(v).toLocaleString(undefined, { maximumFractionDigits: d }));
          const escapeHtml = (s) => String(s==null?'':s)
            .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');

          // Generate grid menu items
          const gridMenuItems = arr.map((r, index) => {
            const title = `${r.Town || ''} ‚Äî ${r.Parcel || ''}`.trim();
            const water = (r.WaterProximity===0) ? 'adjacent' : ((r.WaterProximity!=null && isFinite(Number(r.WaterProximity)) && Number(r.WaterProximity)<=900) ? 'near' : 'far');
            const images = Array.isArray(r.Images) ? r.Images : [];
            const firstImage = images.length > 0 ? images[0] : null;
            const ppa = (r.Price && r.Acres) ? (Number(r.Price)/Number(r.Acres)) : null;
            
            return `
            <div class="menu-item" 
                 onclick="scrollToProperty(${index})"
                 oncontextmenu="event.preventDefault(); togglePropertySelection(${index}); return false;"
                 data-property-index="${index}"
                 id="menu-item-${index}"
                 title="Click to view details ‚Ä¢ Right-click to add to calculator">
              <div class="w-16 h-16 mx-auto mb-2 bg-slate-100 rounded-lg overflow-hidden">
                ${firstImage ? `
                  <img src="${escapeHtml(firstImage)}" 
                       alt="${escapeHtml(title)}" 
                       class="w-full h-full object-cover"
                       loading="lazy"
                       onerror="this.style.display='none'">
                ` : `
                  <div class="w-full h-full flex items-center justify-center text-slate-400 text-xs">
                    üèûÔ∏è
                  </div>
                `}
              </div>
              <div class="font-semibold text-base truncate mb-1" title="${escapeHtml(title)}">${escapeHtml(title)}</div>
              <div class="text-xl font-extrabold text-green-700 mb-0.5">${escapeHtml(fmtCurrency(r.Price))}</div>
              <div class="text-sm text-slate-600 mb-2">${escapeHtml(fmtNumber(r.Acres))} acres</div>
              <div class="flex justify-center gap-1 mb-2">
                <span class="px-2 py-0.5 bg-slate-100 text-xs rounded-full">${escapeHtml(String(r.Tag||'inbox'))}</span>
                <span class="px-2 py-0.5 bg-blue-100 text-xs rounded-full">${escapeHtml(water)}</span>
              </div>
              <div class="text-xs text-slate-400 mb-2">${ppa!=null ? escapeHtml(fmtCurrency(ppa)) + '/acre' : ''}</div>
              <a href="land-detail.html?id=${index}" class="text-xs text-green-600 hover:text-green-800 underline font-medium">See More</a>
            </div>`;
          }).join('\n');
          
          gridMenuContainer.innerHTML = gridMenuItems;

          // Generate compact detailed cards
          const cards = arr.map((r, index) => {
            const title = `${r.Town || ''} ‚Äî ${r.Parcel || ''}`.trim();
            const details = (r.Note || '').split(/\n+/).slice(0, 3).map(p => `<p class="text-xs text-slate-600">${escapeHtml(p)}</p>`).join('');
            const ppa = (r.Price && r.Acres) ? (Number(r.Price)/Number(r.Acres)) : null;
            const water = (r.WaterProximity===0) ? 'adjacent' : ((r.WaterProximity!=null && isFinite(Number(r.WaterProximity)) && Number(r.WaterProximity)<=900) ? 'near' : 'far');
            const analysis = window.acreAnalysis && regionStats ? window.acreAnalysis.analyzeProperty(r, regionStats) : null;
            const ppaClass = analysis?.ppaColor || '';
            const researchExtra = (window.Alpine?.store('app')?.research && analysis) ? `
              <div class="mt-2 text-xs bg-slate-50 border rounded p-2">
                <div class="flex flex-wrap items-center gap-2 mb-1">
                  ${analysis.badge ? `<span class="px-2 py-0.5 rounded-full ${analysis.badgeColor}">${analysis.badge}</span>` : ''}
                  ${analysis.signal ? `<span class="px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-800">${analysis.signal}</span>` : ''}
                </div>
                <div class="text-slate-600">${analysis.detail || ''}</div>
                ${analysis.percentile!=null ? `<div class="text-slate-500">Percentile vs region: ${analysis.percentile}</div>` : ''}
                ${analysis.regionName ? `<div class="text-slate-500">Region: ${analysis.regionName}</div>` : ''}
                <div class="mt-1"><a href="#" class="text-emerald-700 underline">Open comp dataset</a></div>
                <div class="mt-2">
                  <textarea rows="2" class="w-full border rounded p-1 text-xs" placeholder="Notes..."></textarea>
                </div>
              </div>
            ` : '';
            
            const images = Array.isArray(r.Images) ? r.Images : [];
            const imageHtml = images.length > 0 ? `
              <div class="mb-2">
                <div class="grid grid-cols-3 gap-1">
                  ${images.slice(0, 3).map(img => `
                    <img src="${escapeHtml(img)}" 
                         alt="${escapeHtml(title)}" 
                         class="w-full h-16 object-cover rounded border"
                         loading="lazy"
                         onerror="this.style.display='none'">
                  `).join('')}
                </div>
                ${images.length > 3 ? `<div class="text-xs text-slate-500 mt-1">+${images.length - 3} more</div>` : ''}
              </div>
            ` : '';
            
            return `
            <div id="property-${index}" class="property-card"
                 oncontextmenu="event.preventDefault(); togglePropertySelection(${index}); return false;"
                 title="Right-click to add to calculator">
              ${imageHtml}
              <div class="flex items-start justify-between gap-2 mb-2">
                <div class="min-w-0 flex-1">
                  <div class="font-semibold text-sm truncate">${escapeHtml(title)}</div>
                  <div class="text-xs text-slate-500 truncate">${escapeHtml([r.State, r.County].filter(Boolean).join(', '))}</div>
                </div>
                <div class="text-right flex-none">
                  <div class="text-sm font-medium">${escapeHtml(fmtCurrency(r.Price))}</div>
                  <div class="text-xs text-slate-500">${escapeHtml(fmtNumber(r.Acres))} acres</div>
                </div>
              </div>
              <div class="grid grid-cols-3 gap-2 text-xs mb-2">
                <div><div class="text-slate-500">$/acre</div><div class="font-medium ${ppaClass}">${ppa!=null ? escapeHtml(fmtCurrency(ppa)) : ''}</div></div>
                <div>
                  <div class="text-slate-500">Water</div>
                  <div class="font-medium"><span class="px-2 py-0.5 rounded-full ${water==='adjacent'?'bg-teal-100 text-teal-800':water==='near'?'bg-blue-100 text-blue-800':'bg-slate-100 text-slate-700'}">${escapeHtml(water)}</span></div>
                </div>
                <div>
                  <div class="text-slate-500">Tag</div>
                  <div class="font-medium"><span class="px-2 py-0.5 rounded-full ${String(r.Tag||'inbox').toLowerCase()==='shortlist'?'bg-emerald-100 text-emerald-800':String(r.Tag||'inbox').toLowerCase()==='watch'?'bg-amber-100 text-amber-800':String(r.Tag||'inbox').toLowerCase()==='offer'?'bg-indigo-100 text-indigo-800':'bg-slate-100 text-slate-700'}">${escapeHtml(String(r.Tag||'inbox'))}</span></div>
                </div>
              </div>
              <div class="flex items-center gap-2 text-xs">
                <a href="land-detail.html?id=${index}" class="text-green-600 hover:text-green-800 underline font-medium">See More</a>
                ${r.Link ? `<a href="${escapeHtml(r.Link)}" target="_blank" class="text-teal-600 underline">View listing</a>` : ''}
                <button onclick="togglePropertySelection(${index})" class="text-blue-600 hover:text-blue-800 underline">Add to Calculator</button>
              </div>
              ${details ? `<div class="mt-2 space-y-1">${details}</div>` : ''}
              ${researchExtra}
            </div>`;
          }).join('\n');
          container.innerHTML = cards;
          
          generateDistanceMap(arr);
        } catch (e) {
          document.getElementById('empty').textContent = 'Failed to load land.json';
          document.getElementById('empty').classList.remove('hidden');
        }
      }

      // Global variables for calculator and research
      let selectedProperties = [];
      let allProperties = [];
      let regionStats = null;

      // Scroll to property in detailed view
      function scrollToProperty(index) {
        const element = document.getElementById(`property-${index}`);
        if (element) {
          element.scrollIntoView({ behavior: 'smooth', block: 'start' });
          element.style.backgroundColor = '#fef3c7';
          setTimeout(() => { element.style.backgroundColor = ''; }, 2000);
        }
      }

      // Toggle property selection
      function togglePropertySelection(index) {
        const property = allProperties[index];
        if (!property) return;

        const card = document.getElementById(`property-${index}`);
        const menuItem = document.getElementById(`menu-item-${index}`);
        const isSelected = selectedProperties.some(p => p.index === index);
        
        if (isSelected) {
          selectedProperties = selectedProperties.filter(p => p.index !== index);
          card.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50');
          menuItem.classList.remove('selected');
        } else {
          selectedProperties.push({...property, index});
          card.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50');
          menuItem.classList.add('selected');
        }
        
        updateCalculator();
      }

      // Update calculator display
      function updateCalculator() {
        const selectedContainer = document.getElementById('selected-properties');
        const resultsContainer = document.getElementById('calculator-results');
        
        if (selectedProperties.length === 0) {
          selectedContainer.innerHTML = '<div class="text-xs text-slate-500 italic">Click properties above to add them</div>';
          resultsContainer.innerHTML = '<div class="text-slate-500 italic text-xs">Select properties to see calculations</div>';
          return;
        }

        selectedContainer.innerHTML = selectedProperties.map((prop, i) => `
          <div class="flex items-center justify-between bg-white p-1 rounded border">
            <div class="flex-1">
              <div class="font-medium text-xs">${prop.Town} ‚Äî ${prop.Parcel}</div>
              <div class="text-xs text-slate-500">$${Number(prop.Price).toLocaleString()} ‚Ä¢ ${prop.Acres} acres</div>
            </div>
            <button onclick="removeFromSelection(${i})" class="text-red-500 hover:text-red-700 text-xs">√ó</button>
          </div>
        `).join('');

        const totalPrice = selectedProperties.reduce((sum, prop) => sum + Number(prop.Price), 0);
        const totalAcres = selectedProperties.reduce((sum, prop) => sum + Number(prop.Acres), 0);
        const avgPricePerAcre = totalAcres > 0 ? totalPrice / totalAcres : 0;
        
        const downPayment = totalPrice * 0.20;
        const loanAmount = totalPrice - downPayment;
        const monthlyRate = 0.065 / 12;
        const numPayments = 30 * 12;
        const monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);
        
        const annualTax = totalPrice * 0.015;
        const monthlyTax = annualTax / 12;
        const annualInsurance = totalPrice * 0.003;
        const monthlyInsurance = annualInsurance / 12;
        const totalMonthly = monthlyPayment + monthlyTax + monthlyInsurance;

        resultsContainer.innerHTML = `
          <div class="space-y-2">
            <div class="grid grid-cols-2 gap-1 text-xs">
              <div class="bg-white p-1 rounded border">
                <div class="text-slate-500">Properties</div>
                <div class="font-semibold">${selectedProperties.length}</div>
              </div>
              <div class="bg-white p-1 rounded border">
                <div class="text-slate-500">Total Price</div>
                <div class="font-semibold">$${totalPrice.toLocaleString()}</div>
              </div>
              <div class="bg-white p-1 rounded border">
                <div class="text-slate-500">Total Acres</div>
                <div class="font-semibold">${totalAcres.toFixed(1)}</div>
              </div>
              <div class="bg-white p-1 rounded border">
                <div class="text-slate-500">Avg $/Acre</div>
                <div class="font-semibold">$${avgPricePerAcre.toLocaleString()}</div>
              </div>
            </div>
            
            <div class="bg-green-50 p-2 rounded border border-green-200">
              <div class="text-xs font-semibold text-green-800 mb-1">Monthly Costs</div>
              <div class="space-y-1 text-xs">
                <div class="flex justify-between">
                  <span>Mortgage (20% down, 6.5%)</span>
                  <span class="font-medium">$${monthlyPayment.toFixed(0)}</span>
                </div>
                <div class="flex justify-between">
                  <span>Tax + Insurance</span>
                  <span class="font-medium">$${(monthlyTax + monthlyInsurance).toFixed(0)}</span>
                </div>
                <div class="flex justify-between border-t pt-1 font-semibold text-green-800">
                  <span>Total Monthly</span>
                  <span>$${totalMonthly.toFixed(0)}</span>
                </div>
              </div>
            </div>
            
            <div class="bg-blue-50 p-2 rounded border border-blue-200">
              <div class="text-xs font-semibold text-blue-800 mb-1">Down Payment</div>
              <div class="text-sm font-bold text-blue-900">$${downPayment.toLocaleString()}</div>
            </div>
          </div>
        `;
      }

      // Remove property from selection
      function removeFromSelection(index) {
        const removed = selectedProperties[index];
        selectedProperties.splice(index, 1);
        const card = document.getElementById(`property-${removed.index}`);
        const menuItem = document.getElementById(`menu-item-${removed.index}`);
        card.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50');
        menuItem.classList.remove('selected');
        updateCalculator();
      }

      // Clear all selections
      function clearSelection() {
        selectedProperties.forEach(prop => {
          const card = document.getElementById(`property-${prop.index}`);
          const menuItem = document.getElementById(`menu-item-${prop.index}`);
          card.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50');
          menuItem.classList.remove('selected');
        });
        selectedProperties = [];
        updateCalculator();
      }

      // Toggle dropdown sections
      function toggleDropdown(sectionId) {
        const section = document.getElementById(sectionId);
        const arrow = document.getElementById(sectionId + '-arrow');
        
        if (section.classList.contains('hidden')) {
          section.classList.remove('hidden');
          arrow.textContent = '‚ñ≤';
        } else {
          section.classList.add('hidden');
          arrow.textContent = '‚ñº';
        }
      }

      // Generate distance map
      function generateDistanceMap(properties) {
        const homeAddress = "206 Saint John Street";
        const distanceContainer = document.getElementById('distance-map');
        
        if (properties.length === 0) {
          distanceContainer.innerHTML = '<div class="text-center text-slate-500 italic text-xs col-span-full">No properties to map</div>';
          return;
        }

        const homeCoords = { lat: 41.3083, lng: -72.9279 };
        
        const distanceCards = properties.map((prop, index) => {
          const address = `${prop.Parcel}, ${prop.Town}, ${prop.State}`;
          const distance = calculateDistance(homeCoords, getPropertyCoords(prop));
          const driveTime = estimateDriveTime(distance);
          
          const images = Array.isArray(prop.Images) ? prop.Images : [];
          const firstImage = images.length > 0 ? images[0] : null;
          
          return `
            <div class="bg-white rounded-lg p-3 border shadow-sm text-center hover:shadow-md transition-shadow cursor-pointer"
                 onclick="scrollToProperty(${index})"
                 title="Click to view property details">
              <div class="w-12 h-12 mx-auto mb-2 rounded-lg overflow-hidden bg-slate-100">
                ${firstImage ? `
                  <img src="${firstImage}" 
                       alt="${prop.Town} property" 
                       class="w-full h-full object-cover"
                       loading="lazy"
                       onerror="this.style.display='none'">
                ` : `
                  <div class="w-full h-full flex items-center justify-center text-slate-400 text-lg">
                    üèûÔ∏è
                  </div>
                `}
              </div>
              
              <div class="text-xs font-medium text-slate-700 mb-1 truncate" title="${prop.Town}, ${prop.State}">${prop.Town}, ${prop.State}</div>
              <div class="text-xs text-slate-500 mb-2 truncate" title="${address}">${prop.Parcel}</div>
              
              <div class="text-xl font-bold text-green-600 mb-1">${distance.toFixed(1)} mi</div>
              <div class="text-xs text-slate-600 mb-2">${driveTime}</div>
              
              <div class="space-y-1">
                <div class="text-sm font-semibold text-slate-800">$${Number(prop.Price).toLocaleString()}</div>
                <div class="text-xs text-slate-500">${prop.Acres} acres</div>
                <div class="text-xs text-slate-400">$${Math.round(Number(prop.Price)/Number(prop.Acres)).toLocaleString()}/acre</div>
              </div>
            </div>
          `;
        }).join('');

        distanceContainer.innerHTML = distanceCards;
      }

      // Get property coordinates
      function getPropertyCoords(property) {
        const coords = {
          'Cheshire': { lat: 41.4981, lng: -72.9007 },
          'Sherman': { lat: 41.5804, lng: -73.4962 },
          'Torrington': { lat: 41.8009, lng: -73.1212 },
          'Smithfield': { lat: 41.8887, lng: -71.5495 },
          'Lebanon': { lat: 41.6440, lng: -72.2100 },
          'Norwich': { lat: 41.5245, lng: -72.0759 },
          'Putnam': { lat: 41.9154, lng: -71.9089 },
          'Clifton Park': { lat: 42.8656, lng: -73.7708 },
          'Monterey': { lat: 42.1895, lng: -73.2121 },
          'Tolland': { lat: 42.0648, lng: -72.9990 },
          'Ware': { lat: 42.2598, lng: -72.2398 },
          'New Marlborough': { lat: 42.1220, lng: -73.2284 },
          'Brimfield': { lat: 42.1226, lng: -72.2006 },
          'Sheffield': { lat: 42.1098, lng: -73.3551 },
          'Becket': { lat: 42.3333, lng: -73.0833 },
          'Hinsdale': { lat: 42.4333, lng: -73.1167 },
          'Florida': { lat: 42.6667, lng: -73.0167 },
          'North Adams': { lat: 42.7000, lng: -73.1167 }
        };
        
        return coords[property.Town] || { lat: 41.3083, lng: -72.9279 };
      }

      // Calculate distance using Haversine formula
      function calculateDistance(coord1, coord2) {
        const R = 3959;
        const dLat = (coord2.lat - coord1.lat) * Math.PI / 180;
        const dLng = (coord2.lng - coord1.lng) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(coord1.lat * Math.PI / 180) * Math.cos(coord2.lat * Math.PI / 180) *
                  Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      }

      // Estimate drive time
      function estimateDriveTime(distance) {
        if (distance < 5) return '~10-15 min';
        if (distance < 15) return '~20-30 min';
        if (distance < 30) return '~30-45 min';
        if (distance < 50) return '~45-60 min';
        return '~1+ hours';
      }

      // Mobile menu functions
      function toggleMobileMenu() {
        const menu = document.getElementById('mobile-menu');
        menu.classList.toggle('hidden');
      }

      function closeMobileMenu() {
        const menu = document.getElementById('mobile-menu');
        menu.classList.add('hidden');
      }

      // Smooth scrolling for navigation links
      document.addEventListener('DOMContentLoaded', () => {
        // Add smooth scrolling to all navigation links
        document.querySelectorAll('a[href^="#"]').forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            const targetId = link.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
              targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          });
        });
        // Alpine store for research mode
        document.addEventListener('alpine:init', () => {
          Alpine.store('app', { research: false });
        });
      });

      function toggleResearchMode() {
        try {
          const cur = Alpine.store('app');
          cur.research = !cur.research;
          // re-render cards to show/hide research extras
          main();
        } catch(_e) { /* ignore */ }
      }

      async function loadBenchmarks() {
        try {
          const res = await fetch('data/benchmarks/price_per_acre_regions.json', { cache: 'no-store' });
          if (!res.ok) throw new Error('Failed to load benchmarks');
          const regions = await res.json();
          const list = document.getElementById('benchmarks-list');
          const empty = document.getElementById('benchmarks-empty');
          if (!Array.isArray(regions) || regions.length === 0) { empty.textContent = 'No benchmarks yet'; return; }
          empty.classList.add('hidden');
          list.innerHTML = regions.map(r => {
            const median = r.price_per_acre_median == null ? '‚Äî' : ('$' + Number(r.price_per_acre_median).toLocaleString());
            const low = r.price_per_acre_low == null ? '‚Äî' : ('$' + Number(r.price_per_acre_low).toLocaleString());
            const high = r.price_per_acre_high == null ? '‚Äî' : ('$' + Number(r.price_per_acre_high).toLocaleString());
            const updated = r.last_updated == null ? '‚Äî' : String(r.last_updated);
            return `
              <div class="border rounded-lg p-2 bg-slate-50">
                <div class="text-sm font-semibold mb-1">${r.region}</div>
                <div class="grid grid-cols-2 gap-1 text-xs">
                  <div><div class="text-slate-500">Median $/acre</div><div class="font-medium">${median}</div></div>
                  <div><div class="text-slate-500">Range</div><div class="font-medium">${low} ‚Äì ${high}</div></div>
                  <div><div class="text-slate-500">Last updated</div><div class="font-medium">${updated}</div></div>
                  <div><div class="text-slate-500">Notes</div><div class="font-medium">${r.notes || ''}</div></div>
                </div>
              </div>`;
          }).join('');
        } catch (_e) {
          const empty = document.getElementById('benchmarks-empty');
          empty.textContent = 'Failed to load benchmarks';
        }
      }

      function renderRegionStats(stats) {
        try {
          const list = document.getElementById('region-stats-list');
          const empty = document.getElementById('region-stats-empty');
          const entries = Object.entries(stats || {});
          if (!entries.length) { empty.textContent = 'No region stats yet'; return; }
          empty.classList.add('hidden');
          list.innerHTML = entries.map(([name, s]) => {
            const med = (s && isFinite(Number(s.median_ppacre))) ? ('$' + Number(s.median_ppacre).toLocaleString()) : '‚Äî';
            const p25 = (s && isFinite(Number(s.p25))) ? ('$' + Number(s.p25).toLocaleString()) : '‚Äî';
            const p75 = (s && isFinite(Number(s.p75))) ? ('$' + Number(s.p75).toLocaleString()) : '‚Äî';
            const n = (s && isFinite(Number(s.sample_size))) ? Number(s.sample_size) : 0;
            return `
              <div class="border rounded-lg p-2 bg-slate-50">
                <div class="text-sm font-semibold mb-1">${name}</div>
                <div class="grid grid-cols-2 gap-1 text-xs">
                  <div><div class="text-slate-500">Median $/acre</div><div class="font-medium">${med}</div></div>
                  <div><div class="text-slate-500">IQR</div><div class="font-medium">${p25} ‚Äì ${p75}</div></div>
                  <div><div class="text-slate-500">Samples</div><div class="font-medium">${n}</div></div>
                </div>
              </div>`;
          }).join('');
        } catch(_e) { /* ignore */ }
      }

      main();
    </script>
    <style>
      @media print { .no-print { display: none !important; } body { background: white; } }
    </style>
  </body>
</html>